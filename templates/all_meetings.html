{% extends "base.html" %}

{% block content %}
<h2>All Meetings for {{ committee.code }} - {{ committee.title }}</h2>

<!-- Upcoming Meetings -->
<h4 class="text-success mt-4">Upcoming Meetings</h4>
{% if upcoming_meetings %}
<table class="table table-striped">
    <thead>
        <tr>
            <th>Meeting No</th>
            <th>Date</th>
            <th>Agenda</th>
            <th>Participation</th>
        </tr>
    </thead>
    <tbody>
        {% for m in upcoming_meetings %}
        <tr>
            <td>{{ m.meeting_no|ordinal }} Meeting</td>
            <td>{{ m.date }}</td>
            <td>{{ m.agenda }}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#participation-{{ m.id }}">
                    Status & Actions
                </button>
                <div class="collapse {% if request.args.get('open_meeting') == m.id|string %}show{% endif %} mt-2" 
                     id="participation-{{ m.id }}">
                    <!-- Bulk Action -->
                    <form method="post" action="{{ url_for('send_reminder', meeting_id=m.id) }}">
                        <button name="action" value="reminder_all" class="btn btn-sm btn-warning mb-2">
                            Send Reminder to All Experts
                        </button>
                    </form>
                    <table class="table table-sm">
                        <thead><tr><th>Expert</th><th>Reminder</th><th>Actions</th></tr></thead>
                        <tbody>
                            {% for p in participations if p.meeting_id == m.id %}
                            <tr class="{% if request.args.get('highlight') == p.id|string %}table-warning{% endif %}">
                                <td>{{ p.expert.name }}</td>
                                <td>
                                    {% if p.reminder_sent %}
                                        <span class="text-success">✔</span>
                                    {% else %}
                                        <span class="text-danger">✘</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="post" action="{{ url_for('update_participation', participation_id=p.id) }}">
                                        <button name="action" value="reminder" class="btn btn-sm btn-warning">Send Reminder</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="text-muted">No upcoming meetings.</p>
{% endif %}

<!-- Past Meetings -->
<h4 class="text-secondary mt-4">Past Meetings</h4>
{% if past_meetings %}
<table class="table table-striped">
    <thead>
        <tr>
            <th>Meeting No</th>
            <th>Date</th>
            <th>Agenda</th>
            <th>Participation</th>
        </tr>
    </thead>
    <tbody>
        {% for m in past_meetings %}
        <tr>
            <td>{{ m.meeting_no|ordinal }} Meeting</td>
            <td>{{ m.date }}</td>
            <td>{{ m.agenda }}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#participation-{{ m.id }}">
                    View & Actions
                </button>
                <div class="collapse {% if request.args.get('open_meeting') == m.id|string %}show{% endif %} mt-2" 
                     id="participation-{{ m.id }}">
                    <!-- Bulk Action -->
                    <form method="post" action="{{ url_for('send_completion', meeting_id=m.id) }}">
                        <button name="action" value="status_all" class="btn btn-sm btn-info mb-2">
                            Request Participation Status from All Experts
                        </button>
                    </form>
                    <table class="table table-sm">
                        <thead><tr><th>Expert</th><th>Attendance</th><th>Report</th><th>Actions</th></tr></thead>
                        <tbody>
                            {% for p in participations if p.meeting_id == m.id %}
                            <tr class="{% if request.args.get('highlight') == p.id|string %}table-warning{% endif %}">
                                <td>{{ p.expert.name }}</td>
                                <td>
                                    {% if p.attendance %}
                                        <span class="text-success">✔</span>
                                    {% else %}
                                        <span class="text-danger">✘</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if p.report_submitted %}
                                        <span class="text-success">✔</span>
                                    {% else %}
                                        <span class="text-danger">✘</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="post" action="{{ url_for('update_participation', participation_id=p.id) }}">
                                        <button name="action" value="attendance" class="btn btn-sm btn-success">Mark Attendance</button>
                                        <button name="action" value="report" class="btn btn-sm btn-info">Mark Report</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="text-muted">No past meetings.</p>
{% endif %}

<a href="{{ url_for('add_meeting') }}" class="btn btn-secondary mt-4">Back to Dashboard</a>
{% endblock %}
