{% extends "base.html" %}
{% block content %}
<h1 class="mb-4">Committee Manager Summary</h1>

<!-- Navigation -->
<div class="mb-3">
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-dark">Dashboard</a>
    <a href="{{ url_for('directory') }}" class="btn btn-outline-dark">Update Directory</a>
    <a href="{{ url_for('add_meeting') }}" class="btn btn-outline-primary">+ Add Meeting</a>
</div>

<!-- Top Summary Cards -->
<div class="row mb-4 justify-content-around">
    <!-- Total NMCs -->
    <div class="col-md-2">
        <div class="card text-center mb-4">
            <div class="card-header">Total NMCs</div>
            <div class="card-body">
                <h3>
                    <a role="button" data-bs-toggle="modal" data-bs-target="#nmcModal">
                        {{ total_nmc }}
                    </a>
                </h3>
            </div>
        </div>
    </div>

    <!-- Total SCs -->
    <div class="col-md-2">
        <div class="card text-center mb-4">
            <div class="card-header">Total SCs</div>
            <div class="card-body">
                <h3>
                    <a role="button" data-bs-toggle="modal" data-bs-target="#scModal">
                        {{ total_sc }}
                    </a>
                </h3>
            </div>
        </div>
    </div>

    <!-- Total WGs -->
    <div class="col-md-2">
        <div class="card text-center mb-4">
            <div class="card-header">Total WGs</div>
            <div class="card-body">
                <h3>
                    <a role="button" data-bs-toggle="modal" data-bs-target="#wgModal">
                        {{ total_wg }}
                    </a>
                </h3>
            </div>
        </div>
    </div>

    <!-- Total Memberships -->
    <div class="col-md-2">
        <div class="card text-center mb-4">
            <div class="card-header">Total Memberships</div>
            <div class="card-body">
                <h3>
                    <a role="button" data-bs-toggle="modal" data-bs-target="#membershipModal">
                        {{ total_memberships }}
                    </a>
                </h3>
            </div>
        </div>
    </div>

    <!-- Total Experts -->
    <div class="col-md-2">
        <div class="card text-center mb-4">
            <div class="card-header">Total Experts</div>
            <div class="card-body">
                <h3>
                    <a role="button" data-bs-toggle="modal" data-bs-target="#expertModal">
                        {{ total_experts }}
                    </a>
                </h3>
            </div>
        </div>
    </div>
</div>
<!-- NMC Modal -->
<div class="modal fade" id="nmcModal" tabindex="-1" aria-labelledby="nmcModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nmcModalLabel">National Mirror Committees</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% for nmc in nmcs %}
                <p><strong>{{ nmc.code }}</strong> - {{ nmc.title }}</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- SC Modal -->
<div class="modal fade" id="scModal" tabindex="-1" aria-labelledby="scModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scModalLabel">Subcommittees</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% for nmc in nmcs %}
                {% for sc in nmc.subcommittees if sc.parent_id is none %}
                <p><strong>{{ sc.code }}</strong> - {{ sc.title }}</p>
                {% endfor %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- WG Modal -->
<div class="modal fade" id="wgModal" tabindex="-1" aria-labelledby="wgModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="wgModalLabel">Working Groups</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% for nmc in nmcs %}
                {% for wg in nmc.subcommittees if wg.parent_id is not none %}
                <p><strong>{{ wg.code }}</strong> - {{ wg.title }}</p>
                {% endfor %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Memberships Modal -->
<div class="modal fade" id="membershipModal" tabindex="-1" aria-labelledby="membershipModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="membershipModalLabel">Memberships</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% for m in memberships %}
                <p>{{ m.expert.name }} → {{ m.committee.title }}</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Experts Modal -->
<div class="modal fade" id="expertModal" tabindex="-1" aria-labelledby="expertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="expertModalLabel">Experts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% for expert in experts %}
                <p><strong>{{ expert.name }}</strong> - {{ expert.organisation }}</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Upcoming Meetings & Reminders side-by-side -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100" style="max-height: 250px; overflow-y: auto;">
            <div class="card-header bg-primary text-white">Upcoming Meetings</div>
            <div class="card-body">
                {% if meetings %}
                <ul class="list-unstyled">
                    {% for meeting in meetings[:5] %}
                    <li>
                        <strong>{{ meeting.committee.code }}</strong> - {{ meeting.committee.title }}<br>
                        {{ meeting.date }} (Agenda: {{ meeting.agenda }})
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No upcoming meetings scheduled.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card h-100" style="max-height: 250px; overflow-y: auto;">
            <div class="card-header bg-info text-white">Recent Reminders Sent</div>
            <div class="card-body">
                {% if participations %}
                {% for p in participations if p.reminder_sent %}
                <p>{{ p.expert.name }} reminded for {{ p.meeting.committee.title }} on {{ p.meeting.date }}</p>
                {% endfor %}
                {% else %}
                <p>No reminders sent recently.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- NMC Wise Numeric Summary -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <span>NMC Wise Summary</span>
        <button id="exportBtn" class="btn btn-sm btn-light text-dark">
            <i class="bi bi-download"></i> Export
        </button>
    </div>

    <div class="card-body">
        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width:70%">NMC / SC / WG</th>
                        <th style="width:10%">SCs</th>
                        <th style="width:10%">WGs</th>
                        <th style="width:10%">Experts</th>
                    </tr>
                </thead>
                <tbody>
                    {% for nmc in nmc_summary %}
                    <!-- NMC row -->
                    <tr data-bs-toggle="collapse" data-bs-target="#nmcCollapse{{ nmc.nmc.id }}"
                        class="cursor-pointer bg-nmc">
                        <td>
                            <span class="toggle-icon me-2">&#9654;</span>
                            <strong>{{ nmc.nmc.code }} - {{ nmc.nmc.title }}</strong>
                        </td>
                        <td>{{ nmc.sc_count }}</td>
                        <td>{{ nmc.wg_count }}</td>
                        <td>{{ nmc.expert_count }}</td>
                    </tr>

                    <!-- SC rows inside NMC collapse -->
                    <tr class="collapse" id="nmcCollapse{{ nmc.nmc.id }}">
                        <td colspan="4" class="p-0">
                            <table class="table mb-0">
                                <tbody>
                                    {% for sc in nmc.scs %}
                                    <!-- SC row -->
                                    <tr data-bs-toggle="collapse" data-bs-target="#scCollapse{{ sc.sc.id }}"
                                        class="cursor-pointer bg-sc">
                                        <td class="ps-4">
                                            <span class="toggle-icon me-2">&#9654;</span>
                                            {{ sc.sc.code }} - {{ sc.sc.title }}
                                        </td>
                                        <td>–</td>
                                        <td>{{ sc.wg_count }}</td>
                                        <td>{{ sc.expert_count }}</td>
                                    </tr>

                                    <!-- WG rows inside SC collapse -->
                                    <tr class="collapse" id="scCollapse{{ sc.sc.id }}">
                                        <td colspan="4" class="p-0">
                                            <table class="table mb-0">
                                                <tbody>
                                                    {% for wg in sc.wgs %}
                                                    <tr class="bg-wg">
                                                        <td class="ps-5 text-muted">{{ wg.wg.code }} - {{ wg.wg.title }}
                                                        </td>
                                                        <td>–</td>
                                                        <td>–</td>
                                                        <td>{{ wg.expert_count }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Attach arrow updates only to the collapse target itself
        document.querySelectorAll(".collapse").forEach(function (collapseEl) {
            collapseEl.addEventListener("show.bs.collapse", function (e) {
                // Prevent bubbling from child collapses
                if (e.target !== collapseEl) return;

                const triggerRow = document.querySelector("[data-bs-target='#" + collapseEl.id + "']");
                if (triggerRow) {
                    const icon = triggerRow.querySelector(".toggle-icon");
                    if (icon) icon.innerHTML = "&#9660;"; // down arrow
                }
            });

            collapseEl.addEventListener("hide.bs.collapse", function (e) {
                // Prevent bubbling from child collapses
                if (e.target !== collapseEl) return;

                const triggerRow = document.querySelector("[data-bs-target='#" + collapseEl.id + "']");
                if (triggerRow) {
                    const icon = triggerRow.querySelector(".toggle-icon");
                    if (icon) icon.innerHTML = "&#9654;"; // right arrow
                }
            });
        });
    });
</script>


<!-- Experts and their Nominations -->
<div class="card mt-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <span>Experts and Their Nominations</span>
        <a href="{{ url_for('export_experts') }}" class="btn btn-light btn-sm">Download Excel</a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Organisation</th>
                        <th>NMC</th>
                        <th>Nominations (SC/WG)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expert in experts %}
                    {% set nmc_map = expert.get_nmc_map() %}
                    {% set row_count = nmc_map|length if nmc_map else 1 %}

                    {% if nmc_map %}
                    {% for nmc_code, nominations in nmc_map.items() %}
                    <tr>
                        {% if loop.first %}
                        <td rowspan="{{ row_count }}">{{ expert.name }}</td>
                        <td rowspan="{{ row_count }}">{{ expert.email }}</td>
                        <td rowspan="{{ row_count }}">{{ expert.mobile or "—" }}</td>
                        <td rowspan="{{ row_count }}">{{ expert.organisation }}</td>
                        {% endif %}
                        <td><span class="badge bg-success">{{ nmc_code }}</span></td>
                        <td>
                            {% for nom in nominations %}
                            <span class="badge bg-info text-dark me-1">{{ nom }}</span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td>{{ expert.name }}</td>
                        <td>{{ expert.email }}</td>
                        <td>{{ expert.mobile or "—" }}</td>
                        <td>{{ expert.organisation }}</td>
                        <td><span class="text-muted">No NMC</span></td>
                        <td><span class="text-muted">No nominations</span></td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.getElementById("exportBtn").addEventListener("click", function () {
        // Get table element
        let table = document.querySelector(".table");

        // Convert table to worksheet
        let wb = XLSX.utils.book_new();
        let ws = XLSX.utils.table_to_sheet(table);

        // Append worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, "NMC Summary");

        // Export to Excel file
        XLSX.writeFile(wb, "nmc_summary.xlsx");
    });
</script>

<!-- NMC Modal -->
<div class="modal fade" id="nmcModal" tabindex="-1" aria-labelledby="nmcModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nmcModalLabel">National Mirror Committees</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul>
                    {% for nmc in nmcs %}
                    <li>{{ nmc.code }} - {{ nmc.title }}</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- SC Modal -->
<div class="modal fade" id="scModal" tabindex="-1" aria-labelledby="scModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scModalLabel">Subcommittees</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul>
                    {% for nmc in nmcs %}
                    {% for sc in nmc.subcommittees if sc.parent_id is none %}
                    <li>{{ sc.code }} - {{ sc.title }}</li>
                    {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- WG Modal -->
<div class="modal fade" id="wgModal" tabindex="-1" aria-labelledby="wgModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="wgModalLabel">Working Groups</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul>
                    {% for nmc in nmcs %}
                    {% for wg in nmc.subcommittees if wg.parent_id is not none %}
                    <li>{{ wg.code }} - {{ wg.title }}</li>
                    {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Membership Modal -->
<div class="modal fade" id="membershipModal" tabindex="-1" aria-labelledby="membershipModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="membershipModalLabel">Memberships</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul>
                    {% for m in memberships %}
                    <li>{{ m.expert.name }} → {{ m.committee.title }}</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Expert Modal -->
<div class="modal fade" id="expertModal" tabindex="-1" aria-labelledby="expertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="expertModalLabel">Experts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul>
                    {% for expert in experts %}
                    <li>{{ expert.name }}</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}